<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Sebastián Sanavera</title>
<style>
  :root {
    --wa-bg: #ece5dd;
    --wa-green: #075e54;
    --user: #dcf8c6;
    --bot: #fff;
    --border: #cfd8dc;
    --text: #111;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; font-family: Arial, Helvetica, sans-serif; background: var(--wa-bg); color: var(--text); }
  .wrap { height: 100%; display: flex; justify-content: center; }
  .chat { width: 100%; max-width: 820px; height: 100%; display: flex; flex-direction: column; border-left: 1px solid #0001; border-right: 1px solid #0001; background: #e7ddd3; }
  .header { position: sticky; top: 0; z-index: 2; display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--wa-green); color: #fff; }
  .header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .header .title { display: flex; flex-direction: column; line-height: 1; }
  .header .title small { opacity: .9; }
  .msgs { flex: 1; overflow-y: auto; padding: 12px; scroll-behavior: smooth; background-size: auto, 200px 200px; }
  .row { display: flex; }
  .msg { max-width: 75%; margin: 6px 0; padding: 10px 12px; border-radius: 16px; line-height: 1.48; word-wrap: break-word; position: relative; white-space: normal; }
  .msg p { margin: 6px 0; }
  .msg p:first-child { margin-top: 0; }
  .msg p:last-child { margin-bottom: 0; }
  .msg h3, .msg h4 { margin: 4px 0 6px; font-size: 14px; }
  .msg ul, .msg ol { margin: 6px 0 6px 18px; padding: 0; }
  .msg li { margin: 4px 0; }
  .msg hr { border: none; border-top: 1px solid #e0e0e0; margin: 8px 0; }
  .msg code { background: #f3f3f3; border: 1px solid #e2e2e2; border-radius: 4px; padding: 0 4px; font-family: monospace; }
  .msg a { color: #115e59; text-decoration: underline; }
  .user { margin-left: auto; background: var(--user); }
  .bot { margin-right: auto; background: var(--bot); }
  .stamp { font-size: 11px; opacity: .6; margin-top: 4px; text-align: right; }
  .input { display: flex; gap: 8px; align-items: center; padding: 8px; background: #fff; border-top: 1px solid var(--border); }
  .input input { flex: 1; border: none; font-size: 15px; padding: 12px 14px; outline: none; background: #fff; border-radius: 20px; border: 1px solid #ccc; }
  .input button { border: none; background: var(--wa-green); color: #fff; padding: 10px 18px; border-radius: 20px; cursor: pointer; transition: background 0.2s; }
  .input button:hover { background: #0b7a69; }
  .typing-dots span { display: inline-block; width: 6px; height: 6px; margin: 0 2px; background: #999; border-radius: 50%; animation: blink 1s infinite alternate; }
  .typing-dots span:nth-child(2) { animation-delay: .2s; }
  .typing-dots span:nth-child(3) { animation-delay: .4s; }
  @keyframes blink { to { opacity: .3; } }
</style>
</head>
<body>
<div class="wrap">
  <div class="chat">
    <div class="header">
      <img src="https://scontent.feze8-2.fna.fbcdn.net/v/t39.30808-6/473368712_3020771461419426_7798337052013248264_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=a5f93a&_nc_eui2=AeFsCpGC5RNOcCtM8zNyTCzskOUWJFaMq5eQ5RYkVoyrl9LrYLu-SBPy_LIbM9Tcn4iWcdM54x7In9mOe0n-6j0y&_nc_ohc=eZJI14QDnrgQ7kNvwH0FVgD&_nc_oc=AdnLWs-G5fQfLCFVlJ76UkqPnXCeiQGDyW6nBwuC9VPwKnCSPFfinPKgKlN1DhiA-bQ&_nc_zt=23&_nc_ht=scontent.feze8-2.fna&_nc_gid=cXqvArP2Vw0bUmdMdsjzeQ&oh=00_AfWhJ7nXkY5oAvuaIual7ww-s7Inak3cyh3NctrwZ3R9eA&oe=68A45A5C" alt="Foto" />
      <div class="title"><strong>Sebastián Sanavera</strong><small id="status">en línea</small></div>
    </div>
    <div id="msgs" class="msgs"></div>
    <div class="input">
      <input id="txt" type="text" placeholder="Escribí tu mensaje…" autocomplete="off" />
      <button id="send" type="button">Enviar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
<script>
const msgsEl = document.getElementById('msgs');
const inputEl = document.getElementById('txt');
const sendBtn = document.getElementById('send');
const statusEl = document.getElementById('status');

marked.setOptions({ breaks:true, gfm:true });
const ALLOWED_TAGS = ['p','br','strong','b','em','i','ul','ol','li','h3','h4','hr','code','pre','a','blockquote'];
const ALLOWED_ATTR = { 'a':['href','target','rel'] };

function renderMD(md){
  const raw = marked.parse(md ?? '');
  return DOMPurify.sanitize(raw, { ALLOWED_TAGS, ALLOWED_ATTR });
}

function stamp(){
  const d = new Date();
  return d.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit', hour12:true});
}

function scrollToBottom(){
  setTimeout(() => { msgsEl.scrollTop = msgsEl.scrollHeight; }, 50);
}

function addBubbleHTML(html, who){
  const row = document.createElement('div');
  row.className = 'row';
  const bubble = document.createElement('div');
  bubble.className = 'msg ' + who;
  const content = document.createElement('div');
  content.innerHTML = html;
  const time = document.createElement('div');
  time.className = 'stamp';
  time.textContent = stamp();
  bubble.appendChild(content);
  bubble.appendChild(time);
  row.appendChild(bubble);
  msgsEl.appendChild(row);
  scrollToBottom();
}

function addBubbleMD(md, who){
  addBubbleHTML(renderMD(md), who);
}

let typingRow = null;
function showTypingBubble(){
  if (typingRow) return;
  typingRow = document.createElement('div');
  typingRow.className = 'row';
  const bubble = document.createElement('div');
  bubble.className = 'msg bot';
  const dots = document.createElement('div');
  dots.className = 'typing-dots';
  dots.innerHTML = '<span></span><span></span><span></span>';
  bubble.appendChild(dots);
  typingRow.appendChild(bubble);
  msgsEl.appendChild(typingRow);
  scrollToBottom();
}

function hideTypingBubble(){
  if (!typingRow) return;
  msgsEl.removeChild(typingRow);
  typingRow = null;
  scrollToBottom();
}

function setStatus(txt){
  statusEl.textContent = txt;
}

async function send(){
  const text = inputEl.value.trim();
  if(!text) return;
  addBubbleMD(text, 'user');
  inputEl.value = '';
  setStatus('escribiendo…');
  showTypingBubble();

  try {
    const res = await fetch('/.netlify/functions/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();
    hideTypingBubble();
    addBubbleMD(data.reply || 'No pude responder', 'bot');
  } catch(e){
    hideTypingBubble();
    addBubbleMD('Error: ' + e.message, 'bot');
  } finally {
    setStatus('en línea');
  }
}

sendBtn.addEventListener('click', send);
inputEl.addEventListener('keydown', e => {
  if(e.key === 'Enter'){ e.preventDefault(); send(); }
});

// Mensaje de bienvenida
addBubbleMD('**Listo.** Contame tu caso (seguridad o cálculo de sueldo).', 'bot');
</script>
</body>
</html>
