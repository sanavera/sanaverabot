<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Sebastián Sanavera</title>
<style>
  :root{
    --wa-bg:#ece5dd; --wa-green:#075e54; --user:#dcf8c6; --bot:#fff; --border:#cfd8dc; --text:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--wa-bg);color:var(--text)}
  .wrap{height:100%;display:flex;justify-content:center}
  .chat{width:100%;max-width:820px;height:100%;display:flex;flex-direction:column;border-left:1px solid #0001;border-right:1px solid #0001;background:#e7ddd3}
  .header{position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:10px;padding:10px;background:var(--wa-green);color:#fff}
  .header img{width:40px;height:40px;border-radius:50%;object-fit:cover}
  .header .title{display:flex;flex-direction:column;line-height:1}
  .header .title small{opacity:.9}
  .msgs{flex:1;overflow-y:auto;padding:12px;scroll-behavior:smooth;background-image:linear-gradient(#0000,#0000),url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><g fill="%23ffffff" fill-opacity="0.15"><circle cx="20" cy="20" r="2"/><circle cx="120" cy="80" r="1.6"/><circle cx="60" cy="160" r="1.8"/></g></svg>');background-size:auto,200px 200px}
  .row{display:flex}
  .msg{max-width:78%;margin:6px 0;padding:10px 12px;border-radius:16px;line-height:1.48;word-wrap:break-word;position:relative;white-space:normal}
  .msg p{margin:6px 0}
  .msg p:first-child{margin-top:0}
  .msg p:last-child{margin-bottom:0}
  .msg h3,.msg h4{margin:4px 0 6px;font-size:14px}
  .msg ul,.msg ol{margin:6px 0 6px 18px;padding:0}
  .msg li{margin:4px 0}
  .msg hr{border:none;border-top:1px solid #e0e0e0;margin:8px 0}
  .msg code{background:#f3f3f3;border:1px solid #e2e2e2;border-radius:4px;padding:0 4px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .msg a{color:#115e59;text-decoration:underline}
  .user{margin-left:auto;background:var(--user)}
  .bot{margin-right:auto;background:var(--bot);max-width:96%} /* bot más ancho */
  .stamp{font-size:11px;opacity:.6;margin-top:4px;text-align:right}
  .input{display:flex;gap:8px;align-items:center;padding:8px;background:#fff;border-top:1px solid var(--border)}
  .input input{flex:1;border:none;font-size:15px;padding:12px 10px;outline:none;background:#fff}
  .input button{border:none;background:var(--wa-green);color:#fff;padding:10px 18px;border-radius:8px;cursor:pointer}
  .typing{display:inline-block;min-width:36px}
  .dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin:0 2px;background:#999;animation:blink 1s infinite alternate}
  .dot:nth-child(2){animation-delay:.2s}
  .dot:nth-child(3){animation-delay:.4s}
  @keyframes blink{to{opacity:.3}}
</style>
</head>
<body>
<div class="wrap">
  <div class="chat">
    <div class="header">
      <img src="https://via.placeholder.com/40" alt="Biji" />
      <div class="title"><strong>Sebastián Sanavera</strong><small>en línea</small></div>
    </div>

    <div id="msgs" class="msgs"></div>

    <div class="input">
      <input id="txt" type="text" placeholder="Escribí tu mensaje…" autocomplete="off" />
      <button id="send" type="button">Enviar</button>
    </div>
  </div>
</div>

<!-- Markdown parser + Sanitizer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<script>
// ==================== CONFIG ====================
const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
const MODEL   = 'deepseek/deepseek-r1:free'; // gratis
const API_KEY = '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';       // ⚠️ usá backend/proxy en prod

// PROMPT largo + formato requerido
const systemPrompt = `
Sos **Sebastián Sanavera**. Español rioplatense (vos). Tono humano y claro. Intentá ser **breve** cuando alcance.

FORMATO OBLIGATORIO:
- Respondé SIEMPRE en **Markdown** con títulos breves (###), listas con viñetas o numeradas y líneas en blanco entre secciones.
- Si das ejemplos, separalos con \`---\` y subtítulos.

DOMINIO PERMITIDO (único):
1) **Seguridad privada en Argentina** (operativa diaria: preguardia, molinete, CCTV, recorridas; comunicación con encargados, libro de novedades, mail/parte; feriados, nocturnidad, turnos; trato con delegados, acceso visitantes y contratistas; buenas prácticas y seguridad física). 
2) **Proyecto "Calculadora de sueldo de vigilador"** (nuestra web/app): sabe que:
   - Calcula por **día** y por **horas**.
   - En **Opciones avanzadas** se puede configurar: desde cuándo cuentan **horas extra**, valores de **hora normal**, **50%** y **100%**, cálculo por horas, **afiliación sindical** para descuentos, **turno noche**/**nocturnidad**, feriados trabajados/no trabajados, adicionales del sector, y límites/umbrales.
   - La idea es ajustar parámetros al caso real y comparar con el recibo.

POLÍTICA DE RESPUESTA:
- No cites leyes ni artículos salvo que lo pidan explícitamente o sea imprescindible; si citás, solo nombre y artículo en una frase, con aviso de variaciones por provincia/paritarias.
- Si faltan datos, hacé **1 sola pregunta clave** (no interrogatorios).
- Si te preguntan fuera del dominio, respondé exactamente: "Solo puedo hablar de seguridad privada en Argentina o del proyecto de cálculo de sueldo".

PROTOCOLO PARA CASOS DE SUELDO ("me pagan mal", etc.):
1) Pedí **1 dato clave** entre: mes/año y fecha de pago, provincia, categoría/antigüedad/adicionales, horas 50/100 y nocturnidad, afiliación/descuentos, si el recibo tiene no remunerativos.
2) Indicá **2–3 pasos** en la calculadora (qué tocar en Opciones avanzadas) y qué comparar en el recibo.
3) Cerrá con **una** pregunta puntual si falta info.
`;

// ==================== Markdown helpers ====================
marked.setOptions({ breaks:true, gfm:true });
const ALLOWED_TAGS = ['p','br','strong','b','em','i','ul','ol','li','h3','h4','hr','code','pre','a','blockquote'];
const ALLOWED_ATTR = { 'a':['href','target','rel'] };

function normalizeMarkdown(md){
  if(!md) return '';
  let s = md.trim();
  // Forzar saltos antes de listas que vienen corridas
  s = s.replace(/(?<!\n)\s(\d{1,2})[.)]\s/g, '\n$1. '); // 1. 2. 3.
  s = s.replace(/(?<!\n)\s[-•]\s/g, '\n- ');            // - bullets
  s = s.replace(/\s+---\s+/g, '\n\n---\n\n');           // separadores
  // Compactar saltos excesivos
  s = s.replace(/\n{3,}/g, '\n\n');
  return s;
}
function renderMD(md){
  const raw = marked.parse(normalizeMarkdown(md));
  return DOMPurify.sanitize(raw, { ALLOWED_TAGS, ALLOWED_ATTR });
}

// ==================== UI helpers ====================
const msgsEl  = document.getElementById('msgs');
const inputEl = document.getElementById('txt');
const sendBtn = document.getElementById('send');

function stamp(){
  const d=new Date();
  return d.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit', hour12:true});
}
function scrollToBottom(){
  const run=()=>{msgsEl.scrollTop = msgsEl.scrollHeight;};
  run(); requestAnimationFrame(run); setTimeout(run, 50); setTimeout(run, 150);
}
function addBubbleHTML(html, who){
  const row = document.createElement('div'); row.className='row';
  const bubble = document.createElement('div'); bubble.className='msg ' + who;
  const content = document.createElement('div'); content.innerHTML = html;
  const time = document.createElement('div'); time.className='stamp'; time.textContent = stamp();
  bubble.appendChild(content); bubble.appendChild(time);
  row.appendChild(bubble); msgsEl.appendChild(row); scrollToBottom();
}
function addBubbleMD(md, who){ addBubbleHTML(renderMD(md), who); }

let typingRow = null;
function showTyping(){
  if (typingRow) return;
  typingRow = document.createElement('div'); typingRow.className='row';
  const b = document.createElement('div'); b.className='msg bot';
  const span=document.createElement('span'); span.className='typing'; span.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  const time = document.createElement('div'); time.className='stamp'; time.textContent = 'escribiendo…';
  b.appendChild(span); b.appendChild(time); typingRow.appendChild(b); msgsEl.appendChild(typingRow); scrollToBottom();
}
function hideTyping(){ if(!typingRow) return; msgsEl.removeChild(typingRow); typingRow=null; scrollToBottom(); }

// ==================== Conversation state ====================
const history = [ { role: 'system', content: systemPrompt } ];

async function callLLM(){
  const payload = { model: MODEL, messages: history };
  const res = await fetch(API_URL,{
    method:'POST',
    headers:{
      'Authorization': `Bearer ${API_KEY}`,
      'Content-Type':'application/json',
      'HTTP-Referer': window.location.origin,
      'X-Title': 'Sueldo Vigilador Chat'
    },
    body: JSON.stringify(payload)
  });

  let data = null; try { data = await res.json(); } catch(e) { throw new Error('Respuesta inválida de la API'); }
  if (!res.ok) throw new Error(data?.error?.message || `HTTP ${res.status}`);
  if (data?.error) throw new Error(data.error.message || 'Error API');

  const choice = data?.choices?.[0] || {}; const msg = choice.message || {};
  let content = msg.content || choice.text || data.response || msg.reasoning || '';
  if (!content || !content.trim()) throw new Error('Sin contenido del modelo');

  history.push({ role:'assistant', content });
  return content;
}

async function send(){
  const text = inputEl.value.trim(); if(!text) return;
  addBubbleMD(text,'user');
  inputEl.value=''; inputEl.focus();
  history.push({ role:'user', content: text });

  sendBtn.disabled = true; showTyping();
  try{
    const reply = await callLLM(); hideTyping(); addBubbleMD(reply,'bot');
  }catch(err){
    hideTyping(); addBubbleMD('API: ' + err.message,'bot');
    try { // reintento suave
      showTyping(); const r2 = await callLLM(); hideTyping(); addBubbleMD(r2,'bot');
    } catch(e2){ hideTyping(); addBubbleMD('API (reintento): ' + e2.message,'bot'); }
  }finally{ sendBtn.disabled=false; scrollToBottom(); }
}

sendBtn.addEventListener('click', send);
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

// Bienvenida
addBubbleMD('**Listo.** Contame tu caso (seguridad o cálculo de sueldo).','bot');
</script>
</body>
</html>
