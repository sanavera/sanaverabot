<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Sebasti√°n Sanavera</title>
<style>
:root {
  --wa-bg: #ece5dd;
  --wa-green: #075e54;
  --user: #dcf8c6;
  --bot: #fff;
  --border: #cfd8dc;
  --text: #111;
}
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background: var(--wa-bg); }
.wrap { height: 100%; display: flex; justify-content: center; }
.chat { width: 100%; max-width: 820px; display: flex; flex-direction: column; border-left: 1px solid #0001; border-right: 1px solid #0001; background: #e7ddd3; }
.header { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--wa-green); color: #fff; }
.header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
.header .title { display: flex; flex-direction: column; line-height: 1; }
.header .title small { opacity: .9; transition: 0.3s; }
.msgs { flex: 1; overflow-y: auto; padding: 12px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><g fill="%23ffffff" fill-opacity="0.15"><circle cx="20" cy="20" r="2"/><circle cx="120" cy="80" r="1.6"/><circle cx="60" cy="160" r="1.8"/></g></svg>'); background-size: 200px 200px; }
.row { display: flex; }
.msg { max-width: 75%; margin: 6px 0; padding: 10px 12px; border-radius: 16px; line-height: 1.48; word-wrap: break-word; white-space: normal; overflow-wrap: break-word; }
.user { margin-left: auto; background: var(--user); }
.bot { margin-right: auto; background: var(--bot); }
.msg img { max-width: 100%; border-radius: 8px; margin-top: 6px; }
.stamp { font-size: 11px; opacity: .6; margin-top: 4px; text-align: right; }
.input { display: flex; align-items: center; padding: 8px; background: #fff; border-top: 1px solid var(--border); position: relative; }
.input input { flex: 1; border: none; font-size: 15px; padding: 12px 10px; outline: none; }
.input button { border: none; background: var(--wa-green); color: #fff; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
.emoji-btn { background: transparent; font-size: 20px; padding: 5px; cursor: pointer; }
.emoji-picker { display: none; position: absolute; bottom: 60px; background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 5px; flex-wrap: wrap; width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.emoji-picker span { cursor: pointer; font-size: 20px; padding: 4px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="chat">
    <div class="header">
      <img src="https://via.placeholder.com/40" alt="Foto" id="profile-pic" />
      <div class="title">
        <strong>Sebasti√°n Sanavera</strong>
        <small id="status">en l√≠nea</small>
      </div>
    </div>

    <div id="msgs" class="msgs"></div>

    <div class="input">
      <button class="emoji-btn" id="emoji-btn">üòä</button>
      <div class="emoji-picker" id="emoji-picker"></div>
      <input id="txt" type="text" placeholder="Escrib√≠ tu mensaje‚Ä¶" autocomplete="off" />
      <button id="send" type="button">Enviar</button>
    </div>
  </div>
</div>

<!-- Markdown parser + Sanitizer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<script>
// Configuraci√≥n Markdown segura
marked.setOptions({ breaks: true, gfm: true });
const ALLOWED_TAGS = ['p','br','strong','b','em','i','ul','ol','li','h3','h4','hr','code','pre','a','blockquote','img'];
const ALLOWED_ATTR = { 'a':['href','target','rel'], 'img':['src','alt'] };
function renderMD(md){
  const raw = marked.parse(md ?? '');
  return DOMPurify.sanitize(raw, { ALLOWED_TAGS, ALLOWED_ATTR });
}

// Elementos
const msgsEl = document.getElementById('msgs');
const inputEl = document.getElementById('txt');
const sendBtn = document.getElementById('send');
const statusEl = document.getElementById('status');

// Emojis
const emojis = ["üòÄ","üòÇ","üòä","üòç","üòé","üò¢","üëç","üëé","üôè","ü§î","üòÖ","üòÅ","üò°","üò±","üí™","üëå","üôå","üî•","‚ù§Ô∏è","üöì"];
const emojiPicker = document.getElementById('emoji-picker');
document.getElementById('emoji-btn').addEventListener('click', () => {
  emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
});
emojis.forEach(e => {
  const span = document.createElement('span');
  span.textContent = e;
  span.addEventListener('click', () => {
    inputEl.value += e;
    emojiPicker.style.display = 'none';
    inputEl.focus();
  });
  emojiPicker.appendChild(span);
});
emojiPicker.style.display = 'none';

// Funciones
function stamp(){
  const d = new Date();
  return d.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit', hour12:true});
}
function scrollToBottom(){
  msgsEl.scrollTop = msgsEl.scrollHeight;
}
function addBubbleMD(md, who){
  const row = document.createElement('div');
  row.className = 'row';
  const bubble = document.createElement('div');
  bubble.className = 'msg ' + who;
  bubble.innerHTML = renderMD(md);
  const time = document.createElement('div');
  time.className = 'stamp';
  time.textContent = stamp();
  bubble.appendChild(time);
  row.appendChild(bubble);
  msgsEl.appendChild(row);
  scrollToBottom();
}
function setStatus(text){
  statusEl.textContent = text;
}

// Enviar mensaje
async function send(){
  const text = inputEl.value.trim();
  if(!text) return;
  addBubbleMD(text, 'user');
  inputEl.value = '';
  setStatus('escribiendo‚Ä¶');
  try {
    const res = await fetch('/.netlify/functions/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();
    addBubbleMD(data.reply || 'No pude responder', 'bot');
  } catch(e){
    addBubbleMD('Error: ' + e.message, 'bot');
  } finally {
    setStatus('en l√≠nea');
  }
}

sendBtn.addEventListener('click', send);
inputEl.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); send(); }});

// Bienvenida
addBubbleMD('**Listo.** Contame tu caso (seguridad o c√°lculo de sueldo).', 'bot');
</script>
</body>
</html>
